// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  employee
}

enum OvertimeStatus {
  pending
  approved
  rejected
}

enum HourBankType {
  credit
  debit
}

enum HourBankStatus {
  pending
  approved
  rejected
}

enum AuditAction {
  overtime_created
  overtime_approved
  overtime_rejected
  overtime_updated
  hourbank_credit_created
  hourbank_debit_created
  hourbank_approved
  hourbank_rejected
  employee_created
  employee_deleted
  employee_role_changed
  employee_limit_changed
  employee_exception_added
  employee_exception_removed
  employee_work_schedule_updated
  settings_updated
  settings_logo_updated
  timeclock_entry
  timeclock_lunch_exit
  timeclock_lunch_return
  timeclock_exit
  timeclock_edited
}

enum EntityType {
  overtime
  hourbank
  employee
  settings
  timeclock
}

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  password         String?
  role             UserRole @default(employee)
  name             String
  department       String
  externalId       String?  @unique
  externalAuth     Boolean  @default(false)
  overtimeLimit    Float?
  overtimeExceptions Json?  // Array of { month: number, year: number, additionalHours: number }
  workSchedule     Json?    // Jornada por dia da semana: { monday: { startTime: "08:00", endTime: "18:00" }, ... }
  lunchBreakHours  Float?   // Horas de almoço (ex: 1.0, 1.5)
  lateTolerance    Int?     @default(10) // Tolerância em minutos para atraso
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  overtimes        Overtime[]
  hourBankRecords  HourBankRecord[]
  auditLogs        AuditLog[] @relation("UserAuditLogs")
  targetAuditLogs  AuditLog[] @relation("TargetUserAuditLogs")
  createdOvertimes Overtime[] @relation("CreatedBy")
  approvedOvertimes Overtime[] @relation("ApprovedBy")
  rejectedOvertimes Overtime[] @relation("RejectedBy")
  createdHourBankRecords HourBankRecord[] @relation("CreatedByHourBank")
  approvedHourBankRecords HourBankRecord[] @relation("ApprovedByHourBank")
  rejectedHourBankRecords HourBankRecord[] @relation("RejectedByHourBank")
  timeClockRecords TimeClock[]
  workSchedules    WorkSchedule[]

  @@index([email])
  @@index([role])
  @@index([externalId])
  @@map("users")
}

model WorkSchedule {
  id          String   @id @default(uuid())
  employeeId  String
  dayOfWeek   String   // 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'
  startTime   String   // '08:00' (formato HH:mm)
  endTime     String   // '18:00' (formato HH:mm)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  employee    User     @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, dayOfWeek])
  @@index([employeeId])
  @@index([dayOfWeek])
  @@map("work_schedules")
}

model Overtime {
  id          String         @id @default(uuid())
  employeeId  String
  date        String         // Format: YYYY-MM-DD
  startTime   String         // Format: HH:mm
  endTime     String         // Format: HH:mm
  hours       Float
  reason      String
  status      OvertimeStatus @default(pending)
  createdBy   String?
  approvedBy  String?
  rejectedBy  String?
  approvedAt  DateTime?
  rejectedAt  DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  employee    User           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  creator     User?          @relation("CreatedBy", fields: [createdBy], references: [id])
  approver    User?          @relation("ApprovedBy", fields: [approvedBy], references: [id])
  rejector    User?          @relation("RejectedBy", fields: [rejectedBy], references: [id])
  hourBankRecords HourBankRecord[]

  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@index([employeeId, date])
  @@map("overtimes")
}

model HourBankRecord {
  id              String           @id @default(uuid())
  employeeId      String
  date            String           // Format: YYYY-MM-DD
  type            HourBankType
  hours           Float
  reason          String
  overtimeRecordId String?
  status          HourBankStatus  @default(pending)
  createdBy       String
  approvedBy      String?
  rejectedBy      String?
  approvedAt      DateTime?
  rejectedAt      DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  employee        User             @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  overtimeRecord  Overtime?        @relation(fields: [overtimeRecordId], references: [id])
  creator         User             @relation("CreatedByHourBank", fields: [createdBy], references: [id])
  approver        User?            @relation("ApprovedByHourBank", fields: [approvedBy], references: [id])
  rejector        User?            @relation("RejectedByHourBank", fields: [rejectedBy], references: [id])
  timeClockCredit TimeClock[]      @relation("TimeClockCredit")
  timeClockDebit  TimeClock[]      @relation("TimeClockDebit")

  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@index([employeeId, date])
  @@index([employeeId, status])
  @@index([overtimeRecordId])
  @@map("hour_bank_records")
}

model AuditLog {
  id          String      @id @default(uuid())
  action      AuditAction
  entityType  EntityType
  entityId    String      // Can be UUID or other identifier
  userId      String
  targetUserId String?
  description String
  metadata    Json?       @default("{}")
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user        User        @relation("UserAuditLogs", fields: [userId], references: [id])
  targetUser  User?       @relation("TargetUserAuditLogs", fields: [targetUserId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([targetUserId])
  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([entityType, entityId])
  @@index([action, createdAt(sort: Desc)])
  @@map("audit_logs")
}

model TimeClock {
  id                String    @id @default(uuid())
  employeeId        String
  date              String    // Format: YYYY-MM-DD
  entryTime         DateTime? // Entrada
  lunchExitTime     DateTime? // Saída para almoço
  lunchReturnTime   DateTime? // Volta do almoço
  exitTime          DateTime? // Saída final
  totalWorkedHours  Float?    // Horas trabalhadas (sem contar almoço)
  scheduledHours    Float?    // Horas esperadas do dia
  lateMinutes       Int?      // Minutos de atraso
  overtimeHours     Float?    // Horas extras (se trabalhou além do horário)
  negativeHours     Float?    // Horas negativas (se saiu antes)
  hourBankCreditId  String?   // ID do crédito criado (se houver hora extra)
  hourBankDebitId   String?   // ID do débito criado (se houver abatimento)
  justification     String?   // Justificativa para atraso ou horas não cumpridas (texto livre ou motivo da TimeClockJustification)
  justificationId   String?   // ID da justificativa pré-definida (opcional)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  employee          User      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  hourBankCredit    HourBankRecord? @relation("TimeClockCredit", fields: [hourBankCreditId], references: [id])
  hourBankDebit     HourBankRecord? @relation("TimeClockDebit", fields: [hourBankDebitId], references: [id])
  justificationReason TimeClockJustification? @relation(fields: [justificationId], references: [id], onDelete: SetNull)

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@index([employeeId, date])
  @@map("time_clocks")
}

model CompanySettings {
  id                      String   @id @default(uuid())
  name                    String   @default("")
  logo                    Bytes?   // BYTEA in PostgreSQL
  logoContentType         String?
  reportHeader            String   @default("")
  reportFooter            String   @default("")
  managerEmail            String?
  defaultOvertimeLimit    Float    @default(40)
  defaultAccumulationLimit Float    @default(0)
  defaultUsageLimit       Float    @default(0)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@map("company_settings")
}

model TimeClockJustification {
  id          String   @id @default(uuid())
  reason      String   @unique // Ex: "Trânsito", "Problemas pessoais", etc.
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  timeClockRecords TimeClock[]

  @@map("time_clock_justifications")
}

